# UCP Service

## Quick introduction

Creating a minimalistic Mist device has three parts; the Wish Service Object (WSO), the Device Interface Object (DIO) and the Device Driver Object (DDO). In the example the WSO is contained in the `UcpApp`, DIO is the `MistTempSensor`, and the DDO is the `TemperatureSensorDDO`.

## Getting started

### Prerequisites

Install Wish-Core, Wish-Http-Api and Mist-UI. And add at least one identity via Http-Api. 

```bash
sudo npm install -g wish-core wish-http-api wish-ucp-ui
```

Read their respective `README.md` files for further instructions.

### Running example

```bash
npm install wish-ucp-device
```

Copy and paste the code below to a test.js file and run `DEBUG=* node test.js`.

```js
var util = require("util");
var EventEmitter = require("events").EventEmitter;
var UcpApp = require('wish-ucp-device').UcpApp;
var UcpDevice = require('wish-ucp-device').UcpDevice;
var UcpFeature = require('wish-ucp-device').UcpFeature;

// Dummy Device Driver for Temperature Sensor
function TemperatureSensorDDO() {
    var self = this; 

    this.deviceData = {};
    this.tick = 0;
    
    // Dummy sensor reading generator
    setInterval(function() {
        self.tick++;;
        var temperature = 5+Math.sin(2*Math.PI*self.tick/60/60/24)
                * 10+Math.sin(2*Math.PI*self.tick/60/60/24/365)
                * 10+Math.random()*0.2-0.4;
        self.emit('change', 'temperature', Math.round(temperature*10));
    }, 981);
}

util.inherits(TemperatureSensorDDO, EventEmitter);

TemperatureSensorDDO.prototype.write = function(feature, value) {
    this.deviceData[feature] = value;
    this.emit('change', feature, value);
};

function MistTempSensor() {
    var descriptor = {
        name: 'Mist Temperature Sensor',
        desc: 'A dummy device with ucp support, playing the game of a temperature sensor',
        wsid: 'ucpctrl-1',
        protocols: [{name: 'ucp'}],
        core: { ws: 'ws://localhost:9090' }
    };

    // Creates a Wish Service Object (WSO)
    this.app = new UcpApp(descriptor);

    // Init the sensor Device Driver Object (DDO)
    var sensor = new TemperatureSensorDDO();

    // Start the Device Interface Object (DIO)
    var ucpDevice = new UcpDevice('Temperature Sensor');

    var temperature = new UcpFeature({
        type: 'int16',
        label: 'Temperature',
        unit: 'Â°C',
        scale: 0.1,
        data: 0
    });

    ucpDevice.addFeature('temperature', temperature);

    // Connect a change in the device driver (DDO) to a feature in DIO
    sensor.on('change', function (feature, value) {
        if (feature === 'temperature') {
            temperature.deviceUpdate(value);
        }
    });

    this.app.attachUcpDevice(ucpDevice);
    ucpDevice.attachInterface(this.app);
}

// Start everything up
var mistSensor = new MistTempSensor(); 
```
